---
title: "flutter_hooksã‚’èª­ã‚€"
emoji: "ğŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [
  "flutter",
  "flutterhooks",
]
published: true
published_at: "2024-09-25 17:00"
---

https://pub.dev/packages/flutter_hooks

flutter_hooksã¯ã€Flutterã®ä¸–ç•Œã«Hooksã‚’æŒã¡è¾¼ã‚€ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚[Provider](https://pub.dev/packages/provider)ã‚„[Riverpod](https://pub.dev/packages/riverpod)ã®ä½œè€…ã§ã‚ã‚‹Remi Rousseletæ°ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚

> A Flutter implementation of React hooks: https://medium.com/@dan_abramov/making-sense-of-react-hooks-fdbde8803889
> 
> Hooks are a new kind of object that manage the life-cycle of a Widget. They exist for one reason: increase the code-sharing between widgets by removing duplicates.

flutter_hooksã¯ã€åˆ©ç”¨è€…å´ã‹ã‚‰ã™ã‚‹ã¨ã€Œ`use`ã‚’ä½¿ã£ã¦ã„ã„æ„Ÿã˜ã«hookã‚’å‘¼ã³å‡ºã™ã€ã‚‚ã®ã§ã™ã€‚
ã“ã®ä»•çµ„ã¿ã¯ã€ã€Œ`HookElement`ã«ã‚ˆã‚‹`StatelessElement`/`StatefulElement`ã®æ‹¡å¼µã€ã«ã‚ˆã‚Šå®Ÿç¾ã•ã‚Œã¾ã™ã€‚`HookElement`ã‚’ç†è§£ã§ãã‚Œã°ã€flutter_hooksã‚’ç†è§£ã§ããŸã¨ã„ã£ã¦ã‚‚éè¨€ã§ã¯ãªã„ã§ã—ã‚‡ã†ã€‚

ã“ã®è¨˜äº‹ã¯ã€ãã‚“ãªãƒãƒªã§ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã‚‚ã®ã§ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€åŸ·ç­†æ™‚ç‚¹ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹`0.21.0`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## HookElement

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/framework.dart#L371-L577

å¯èª­æ€§ã®ãŸã‚ã«ã‚³ãƒ¼ãƒ‰ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’çœç•¥ã™ã‚‹ãŸã‚ã€ä¸€é€šã‚ŠæŠŠæ¡ã—ã¦ã‹ã‚‰å¤§å…ƒã®ã‚³ãƒ¼ãƒ‰ã«æˆ»ã£ã¦èª­ã‚€ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

### buildãƒ¡ã‚½ãƒƒãƒ‰é–¢é€£

`HookElement`ã¯ã€`ComponentElement`ã‚’å¯¾è±¡ã¨ã—ãŸmixinã§ã™ã€‚

https://api.flutter.dev/flutter/widgets/ComponentElement-class.html

æ¬¡ã®4ãƒ¡ã‚½ãƒƒãƒ‰ã‚’`build`ãƒ¡ã‚½ãƒƒãƒ‰ã«é–¢é€£ã™ã‚‹ã‚‚ã®ã¨ã—ã¦ã€æŠœãå‡ºã—ã¦ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

- [update](https://api.flutter.dev/flutter/widgets/Element/update.html)
- [didChangeDependencies](https://api.flutter.dev/flutter/widgets/Element/didChangeDependencies.html)
- [reassemble](https://api.flutter.dev/flutter/widgets/Element/reassemble.html)
- [build](https://api.flutter.dev/flutter/widgets/Element/build.html)

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹é™ã‚Šã€`update`ã¨`reassemble`ã¯Hot Reloadæ™‚ã«å‘¼ã°ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚[å®Ÿè£…ã—ãŸPR](https://github.com/rrousselGit/flutter_hooks/pull/142)ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€è‰²ã€…ã¨å‹•ä½œã‚’è©¦ã—ãªãŒã‚‰å®Ÿè£…ã—ã¦ã„ã‚‹æ§˜å­ãŒè¦‹ã¦å–ã‚Œã¾ã™ã€‚^[`State`ã§ã¯ãªã`Element`ã®APIã‚’è§¦ã£ã¦ã„ã‚‹ãŸã‚ã€APIã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé ¼ã‚Šã§èª­ã¿ã¾ã™ã€‚]

ä»¥ä¸Šã®æ–‡è„ˆã‚’è¸ã¾ãˆã€`HookElement`ã®`didChangeDependencies`ã¨`build`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ•´ç†ã—ãŸã‚‚ã®ãŒã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚^[`didChangeDependencies`ã¯`StatefulHookWidget`ã§åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚]

```dart
mixin HookElement on ComponentElement {
  static HookElement? _currentHookElement;

  _Entry<HookState<Object?, Hook<Object?>>>? _currentHookState;
  final _hooks = LinkedList<_Entry<HookState<Object?, Hook<Object?>>>>();
  final _shouldRebuildQueue = LinkedList<_Entry<bool Function()>>();
  LinkedList<_Entry<HookState<Object?, Hook<Object?>>>>? _needDispose;
  bool? _isOptionalRebuild = false;
  Widget? _buildCache;

  @override
  void didChangeDependencies() {
    _isOptionalRebuild = false;
    super.didChangeDependencies();
  }

  @override
  Widget build() {
    // Check whether we can cancel the rebuild (caused by HookState.mayNeedRebuild).
    final mustRebuild = _isOptionalRebuild != true ||
        _shouldRebuildQueue.any((cb) => cb.value());

    _isOptionalRebuild = null;
    _shouldRebuildQueue.clear();

    if (!mustRebuild) {
      return _buildCache!;
    }

    _currentHookState = _hooks.isEmpty ? null : _hooks.first;
    HookElement._currentHookElement = this;
    try {
      _buildCache = super.build();
    } finally {
      _isOptionalRebuild = null;
      _unmountAllRemainingHooks();
      HookElement._currentHookElement = null;
      if (_needDispose != null && _needDispose!.isNotEmpty) {
        for (_Entry<HookState<dynamic, Hook<dynamic>>>? toDispose =
                _needDispose!.last;
            toDispose != null;
            toDispose = toDispose.previous) {
          toDispose.value.dispose();
        }
        _needDispose = null;
      }
    }

    return _buildCache!;
  }

  void _unmountAllRemainingHooks() {
    if (_currentHookState != null) {
      _needDispose ??= LinkedList();
      // Mark all hooks >= this one as needing dispose
      while (_currentHookState != null) {
        final previousHookState = _currentHookState!;
        _currentHookState = _currentHookState!.next;
        previousHookState.unlink();
        _needDispose!.add(previousHookState);
      }
    }
  }
}
```

`mustRebuild`ãŒ`true`ã®å ´åˆã«ã¯ã€`_buildCache`ã‚’å†æ§‹ç¯‰ã—è¿”å´ã—ã¾ã™ã€‚`mustRebuild`ãŒ`false`ã®å ´åˆã«ã¯ã€å‰å›ã®`_buildCache`ã‚’è¿”å´ã—ã¾ã™ã€‚
ã“ã®`mustRebuild`ã¯ã€ã¤ãã®2ã¤ã®æ¡ä»¶ã§`true`ã«ãªã‚Šã¾ã™ã€‚

1. `_isOptionalRebuild`ãŒ`null`ã‚‚ã—ãã¯`false`ã§ã‚ã‚‹
2. `_shouldRebuildQueue`ã®ä¸­ã«`true`ã‚’è¿”ã™é–¢æ•°ãŒã‚ã‚‹

ã“ã®æ¡ä»¶ã¯`HookState`ã®[markMayNeedRebuild](https://pub.dev/documentation/flutter_hooks/latest/flutter_hooks/HookState/markMayNeedRebuild.html)ã‚’å‘¼ã³å‡ºã—ãŸã¨ãã€å¤‰åŒ–ã—ã¾ã™ã€‚`markMayNeedRebuild`ã¯ç‹¬è‡ªã®hookã‚’å®Ÿè£…ã™ã‚‹éš›ã€åˆ©ç”¨ã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®1ã¤ã§ã™ã€‚

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/framework.dart#L292-L313

ã¨ã„ã†ã“ã¨ã§ã€å¤§åŠã®hookã¯ã€Œ`super.build`æ™‚ã«`HookElement._currentHookElement`çµŒç”±ã§`HookElement`ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚`useContext`çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹`BuildContext`ã¯ã€å®Ÿã¯`HookElement._currentHookElement`ã§ã™ã€‚çŸ¥ã‚‰ãšã«è§¦ã£ã¦ã„ãŸæ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚

```dart
BuildContext useContext() {
  assert(
    HookElement._currentHookElement != null,
    '`useContext` can only be called from the build method of HookWidget',
  );
  return HookElement._currentHookElement!;
}
```

### useé–¢é€£

https://pub.dev/documentation/flutter_hooks/latest/flutter_hooks/use.html

flutter_hooksã«ãŠã‘ã‚‹`use`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå®Ÿè£…ã¨ãªã£ã¦ãŠã‚Šã€æœ€çµ‚çš„ã«`HookElement`ã®`_use`ãƒ¡ã‚½ãƒƒãƒ‰ã«è¾¿ã‚Šç€ãã¾ã™ã€‚

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/framework.dart#L11-L18

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/framework.dart#L125-L140

`use`ãƒ¡ã‚½ãƒƒãƒ‰ã®èª¬æ˜ã«ã¯ã€æ¬¡ã®2æ–‡ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

> use must be called within the build method of either HookWidget or StatefulHookWidget. All calls of use must be made outside of conditional checks and always in the same order.

å‰åŠéƒ¨ã«å¯¾å¿œã™ã‚‹ã®ãŒã€`HookElement._currentHookElement`ã§ã™ã€‚

`HookElement._currentHookElement`ã«ã¯ã€å…ˆã»ã©ã®`build`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¦`this`ãŒä»£å…¥ã•ã‚Œã¾ã™ã€‚ã“ã®ä»£å…¥ã¯`super.build()`ã®å‘¼ã³å‡ºã—å‰ã«è¡Œã‚ã‚Œã€`null`ã§åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚ã“ã®å‡¦ç†ã¯åŒæœŸå‡¦ç†ã§ã™ã€‚

å¾ŒåŠéƒ¨ã«å¯¾å¿œã™ã‚‹ã®ãŒã€`_hooks`ã¨`_currentHookState`ã§ã™ã€‚

`_hooks`ã¯`LinkedList`ã§å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€`_use`ãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—æ™‚ã«è¦ç´ ã®è¿½åŠ ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã“ã§é‡è¦ãªã®ã¯ã€`LinkedList`ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¿½åŠ æ¸ˆã¿ã®è¦ç´ ã¯**è‡ªèº«ã®æ¬¡ã®è¦ç´ ã‚’çŸ¥ã£ã¦**ã„ã¾ã™ã€‚ã“ã®ãŸã‚ã€è¤‡æ•°å›`_use`ãŒå‘¼ã³å‡ºã•ã‚ŒãŸéš›ã«ã€ä¿å­˜æ¸ˆã¿ã®listã‚’è¾¿ã‚ŠãªãŒã‚‰å‡¦ç†ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®å‰æã‚’è¸ã¾ãˆã‚‹ã¨ã€`_currentHookState`ã¯ã€`_hooks`ã®ä¸­ã§ç¾åœ¨ã®ä½ç½®ã‚’ç¤ºã™ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã™ã€‚ã‚ã‚‹`HookElement`ã«å¯¾ã—ã¦ã€åˆã‚ã¦hookãŒè¿½åŠ ã•ã‚Œã‚‹éš›ã«ã¯ã€`_currentHookState`ã¯`null`ã¨ãªã‚Šã¾ã™ã€‚ãã®å¾Œã¯å‘¼ã³å‡ºã•ã‚ŒãŸhookãŒ`_currentHookState`ã¨ãªã‚Šã€hookã®å‡¦ç†ã‚’çµ‚ãˆãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§`_currentHookState!.next;`ã«ã‚ˆã‚Šæ¬¡ã®hookã‚’å–å¾—ã—ã¾ã™ã€‚ãªãŠã€ãƒªã‚¹ãƒˆã®æœ€å¾Œã«è¾¿ã‚Šç€ã„ãŸå ´åˆã«ã¯ã€`_currentHookState`ã¯`null`ã«ãªã‚Šã¾ã™ã€‚
ã“ã®å‡¦ç†ã¯**`_use`ã‚’å‘¼ã³å‡ºã™é †ç•ªã«ä¾å­˜**ã™ã‚‹ãŸã‚ã€`use`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™é †ç•ªã¯ä¸€å®šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¸Šè¨˜ã®èª¬æ˜ã‚’è¸ã¾ãˆãŸä¸Šã§ã€`_use`ãƒ¡ã‚½ãƒƒãƒ‰å‘¨è¾ºã®ã‚³ãƒ¼ãƒ‰ã‚’æŠœãå‡ºã™ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```dart
mixin HookElement on ComponentElement {
  _Entry<HookState<Object?, Hook<Object?>>>? _currentHookState;
  final _hooks = LinkedList<_Entry<HookState<Object?, Hook<Object?>>>>();

  @override
  Widget build() {
    // Check whether we can cancel the rebuild (caused by HookState.mayNeedRebuild).
    final mustRebuild = _isOptionalRebuild != true ||
        _shouldRebuildQueue.any((cb) => cb.value());

    _isOptionalRebuild = null;
    _shouldRebuildQueue.clear();

    if (!mustRebuild) {
      return _buildCache!;
    }

    _currentHookState = _hooks.isEmpty ? null : _hooks.first;
    HookElement._currentHookElement = this;
    try {
      _buildCache = super.build();
    } finally {
      _isOptionalRebuild = null;
      _unmountAllRemainingHooks();
      HookElement._currentHookElement = null;
      if (_needDispose != null && _needDispose!.isNotEmpty) {
        for (_Entry<HookState<dynamic, Hook<dynamic>>>? toDispose =
                _needDispose!.last;
            toDispose != null;
            toDispose = toDispose.previous) {
          toDispose.value.dispose();
        }
        _needDispose = null;
      }
    }

    return _buildCache!;
  }

  R _use<R>(Hook<R> hook) {
    /// At the end of the hooks list
    if (_currentHookState == null) {
      _appendHook(hook);
    } else if (hook.runtimeType != _currentHookState!.value.hook.runtimeType) {
      final previousHookType = _currentHookState!.value.hook.runtimeType;
      _unmountAllRemainingHooks();
      throw StateError('''
Type mismatch between hooks:
- previous hook: $previousHookType
- new hook: ${hook.runtimeType}
''');
    } else if (hook != _currentHookState!.value.hook) {
      final previousHook = _currentHookState!.value.hook;
      if (Hook.shouldPreserveState(previousHook, hook)) {
        _currentHookState!.value
          .._hook = hook
          ..didUpdateHook(previousHook);
      } else {
        _needDispose ??= LinkedList();
        _needDispose!.add(_Entry(_currentHookState!.value));
        _currentHookState!.value = _createHookState<R>(hook);
      }
    }

    final result = _currentHookState!.value.build(this) as R;
    _currentHookState = _currentHookState!.next;
    return result;
  }

  HookState<R, Hook<R>> _createHookState<R>(Hook<R> hook) {
    final state = hook.createState()
      .._element = this
      .._hook = hook
      ..initHook();

    return state;
  }

  void _appendHook<R>(Hook<R> hook) {
    final result = _createHookState<R>(hook);
    _currentHookState = _Entry(result);
    _hooks.add(_currentHookState!);
  }
}
```

`_createHookState`ã«é–¢ã—ã¦ã¯ã€å¾Œã»ã©`HookState`ã®å‡¦ç†ã‚’è¦‹ã‚‹ä¸­ã§è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚ä»Šã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ`HookElement`å†…ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã ã‘ã€æŠŠæ¡ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

å‡¦ç†ã®ä¸­ã§é‡è¦ãªã®ã¯ã€æ¬¡ã®ifæ–‡ã§ã—ã‚‡ã†ã€‚ç­†è€…ãŒæŠŠæ¡ã—ãŸç¯„å›²ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

```dart
if (_currentHookState == null) {
  // æ­£å¸¸ç³»ã€hookã®è¿½åŠ 
} else if (hook.runtimeType != _currentHookState!.value.hook.runtimeType) {
  // ç•°å¸¸ç³»ã€_hooksã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹hookã¨ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹hookã®å‹ãŒç•°ãªã‚‹
} else if (hook != _currentHookState!.value.hook) {
  // æ­£å¸¸ç³»ã€hookã®æ›´æ–°
  final previousHook = _currentHookState!.value.hook;
  if (Hook.shouldPreserveState(previousHook, hook)) {
    // hookã‚’å†åˆ©ç”¨ã™ã‚‹å ´åˆ
  } else {
    // hookã‚’ç ´æ£„ã™ã‚‹å ´åˆ
  }
}

// _currentHookStateã‚’_hooksã‹ã‚‰å¾©æ—§ã—ãŸä¸Šã§ã€HookState.buildã®å‘¼ã³å‡ºã—
final result = _currentHookState!.value.build(this) as R;
return result;
```

`use`ã¯`HookWidget`ã‚„`StatefulHookWidget`ã®`build`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ãŒå‰æã¨ãªã£ã¦ã„ã¾ã™ã€‚`build`ãƒ¡ã‚½ãƒƒãƒ‰ã¯Widgetã®ãƒªãƒ“ãƒ«ãƒ‰ãŒèµ°ã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ä½•åº¦`_use`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‹ã¯ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚ä¸Šè¨˜ã®å®Ÿè£…ã¯ã€ä½•åº¦å‘¼ã³å‡ºã•ã‚Œã¦ã‚‚æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### unmountã¨deactivate

`HookElement`ã¯ã€`unmount`ã¨`deactivate`ã‚’overrideã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€`HookState`ã®`dispose`ã¨`deactivate`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

```dart
mixin HookElement on ComponentElement {
  final _hooks = LinkedList<_Entry<HookState<Object?, Hook<Object?>>>>();

  @override
  void unmount() {
    super.unmount();
    if (_hooks.isNotEmpty) {
      for (_Entry<HookState<dynamic, Hook<dynamic>>>? hook = _hooks.last;
          hook != null;
          hook = hook.previous) {
        try {
          hook.value.dispose();
        } catch (exception, stack) {
          FlutterError.reportError(
            FlutterErrorDetails(
              exception: exception,
              stack: stack,
              library: 'hooks library',
              context: DiagnosticsNode.message(
                'while disposing ${hook.runtimeType}',
              ),
            ),
          );
        }
      }
    }
  }

  @override
  void deactivate() {
    for (final hook in _hooks) {
      try {
        hook.value.deactivate();
      } catch (exception, stack) {
        FlutterError.reportError(
          FlutterErrorDetails(
            exception: exception,
            stack: stack,
            library: 'hooks library',
            context: DiagnosticsNode.message(
              'while deactivating ${hook.runtimeType}',
            ),
          ),
        );
      }
    }
    super.deactivate();
  }
}
```

`unmount`ãŒListã®å¾Œã‚ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã®ã§ã€ã¡ã‚‡ã£ã¨ã ã‘è¦‹æ…£ã‚Œãªã„foræ–‡ã«ãªã£ã¦ã„ã¾ã™ãŒã€é †ç¹°ã‚Šã«`dipose`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚`deactivate`ã¯ã€Listã®è¦ç´ ã‚’é †ç¹°ã‚Šã«`deactivate`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚ã°ã‚ã‹ã‚‹é€šã‚Šãªã®ã§ã€ç‰¹ã«ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### HookWidgetã¨StatefulHookWidget

hookã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ä¸Šè¨˜ã®`HookElement`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚`HookWidget`ã¨`StatefulHookWidget`ã¯ã€`HookElement`ã‚’mixinã—ãŸ`Element`ã‚’`createElement`ã§è¿”å´ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/framework.dart#L579-L615

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€`HookElement`ãŒ`_hooks`ã«ã¦ä»»æ„ã®`HookState`ã‚’ä¿æŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ç”Ÿæˆã‚„ç ´æ£„ãŒ`HookElement`ã§ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€`HookState`ã¯é€šå¸¸ã®Elementã¨åŒã˜ã‚ˆã†ã«**Elementã«ã‚ˆã£ã¦StateãŒç®¡ç†ã•ã‚Œã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

---

flutter_hooksã¯Flutterã®Widgetã«`HookElement`ã‚’è¿½åŠ ã—ã€`HookState`ã‚’ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã®ã§ã™ã€‚ãã‚Œãã‚Œã®`HookState`ã¯å¯¾å¿œã™ã‚‹`HookElement`ã®å‚ç…§ã‚’æŒã£ã¦ãŠã‚Šã€`StatefulElement`ã®å®Ÿè£…ã«è¿‘ã„å½¢ã§ã™ã€‚

https://github.com/flutter/flutter/blob/3.24.0/packages/flutter/lib/src/widgets/framework.dart#L5681-L5695

https://github.com/flutter/flutter/blob/3.24.0/packages/flutter/lib/src/widgets/framework.dart#L5697-L5929

Elementã®æŒ¯ã‚‹èˆã„ã«ã¤ã„ã¦ã¯ã€æ¬¡ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚è©²å½“ç®‡æ‰€ã‚’ç¢ºèªã—ãŸã„æ–¹ã¯ã€ã€ŒåˆæœŸã®Elementãƒ„ãƒªãƒ¼ãŒæ§‹ç¯‰ã•ã‚Œã‚‹ã¾ã§ã®æµã‚Œã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://medium.com/flutter-jp/dive-into-flutter-4add38741d07

è‰¯ã„è¦‹æ–¹ã‚’ã™ã‚Œã°ã€`HookWidget`ã¯ã€Œ`StatelessElement`ã«å¯¾ã—ã€éå¸¸ã«å°‘ãªã„å®Ÿè£…ã‚’è¶³ã™ã“ã¨ã§ã€`StatefulElement`ç›¸å½“ã®æŒ¯ã‚‹èˆã„ã‚’å®Ÿç¾ã—ãŸã€ã‚‚ã®ã¨è¨€ãˆã¾ã™ã€‚ä»–ã®è¦‹æ–¹ã‚’ã™ã‚‹ã¨ã€`StatefulElement`ã«å¯¾ã—ã¦ã¯ã€`State`ã®ç®¡ç†ã«`HookState`ã®ç®¡ç†ã‚’è¿½åŠ ã—ãŸã‚‚ã®ã¨è¨€ãˆã¾ã™ã€‚^[`ConsumerHookWidget`ã¯`StatefulWidget`ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿã¯ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã¯å¤šæ•°ã‚ã‚Šã¾ã™ã€‚]

## HookState

`HookState`ã¯ã€ä»»æ„ã®hookã‚’è¨˜è¿°ã™ã‚‹éš›ã«ã€`Hook.createState`ãŒè¿”å´ã™ã‚‹ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿å…ƒã«ãªã‚Šã¾ã™ã€‚æ–‡ç« ã§èª­ã‚€ã¨ã‚ã‹ã‚Šã«ãã„ã®ã§ã€é©å½“ãªhookã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/debounced.dart

`useDebounced`ã¯`use(_DebouncedHook(...))`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§åˆ©ç”¨ã§ãã¾ã™ã€‚`_DebouncedHook`ã¯`Hook`ã‚’ç¶™æ‰¿ã—ã¦ãŠã‚Šã€`createState`ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã“ã®`createState`ã¯`HookState`ã‚’ç¶™æ‰¿ã—ãŸ`_DebouncedHookState`ã‚’è¿”å´ã—ã¦ã„ã¾ã™ã€‚
`StatefulWidget`ãŒ`State`ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ã€`createState`ã§è¿”å´ã™ã‚‹ã®ã¨åŒã˜ã§ã™ã€‚ã“ã®å‘½åã«ã™ã‚‹å¿…è¦ã¯ãªã„ã¨æ€ã‚ã‚Œã¾ã™ãŒã€Flutterã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ç›´æ„Ÿçš„ã«ç†è§£ã—ã¦ã‚‚ã‚‰ã„ã‚„ã™ããªã‚‹ã®ã§ã€ã“ã®ã‚ˆã†ãªå‘½åã«ãªã£ã¦ã„ã‚‹ã¨ç­†è€…ã¯è€ƒãˆã¦ã„ã¾ã™ã€‚

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/framework.dart#L219-L324

`HookState`ã¯ã€åˆå›ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«`createState`ã¨`initHook`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯`HookElement`ã®`_use`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€`HookWidget`ã‚„`StatefulHookWidget`ã®`build`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```dart
HookState<R, Hook<R>> _createHookState<R>(Hook<R> hook) {
  final state = hook.createState()
    .._element = this
    .._hook = hook
    ..initHook();

  return state;
}
```

`StatefulElement`ã®å ´åˆã€Elementã®ç”Ÿæˆæ™‚ã«`createState`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãã®å¾Œã€`Element`ãŒ`mount`ã•ã‚ŒãŸéš›ã«`_firstBuild`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã€`initState`ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãªãŠã€`StatelessElement`ã®å ´åˆã«ã¯ã€`ComponentElement`ã®å®Ÿè£…ã‚’overrideã—ã¦ã„ãªã„ãŸã‚ã€`initState`ã®å‡¦ç†ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚
`Element`ã®`mount`ã«ã¤ã„ã¦ã¯ã€å…ˆã»ã©ã®[åˆæœŸã®Elementãƒ„ãƒªãƒ¼ãŒæ§‹ç¯‰ã•ã‚Œã‚‹ã¾ã§ã®æµã‚Œ](https://medium.com/flutter-jp/dive-into-flutter-4add38741d07)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://github.com/flutter/flutter/blob/3.24.0/packages/flutter/lib/src/widgets/framework.dart#L5588-L5600

https://github.com/flutter/flutter/blob/3.24.0/packages/flutter/lib/src/widgets/framework.dart#L5698-L5726

`HookState`ã®`initHook`ã¨`build`ã¯ã€`State`ã®`initState`ã¨`build`ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ã™ã€‚å®Ÿè£…ã‚’è¦‹æ¯”ã¹ã¦ã¿ã‚‹ã¨ã€ã‚ã‚‹æ„å‘³å½“ç„¶ã§ã¯ã‚ã‚Šã¾ã™ãŒã€`HookState`ã¯`StatefulState`ã«æ¯”ã¹å®Ÿè¡ŒãŒé…å»¶ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯flutter_hooksãŒ3rd party libraryã§ã‚ã‚‹ãŸã‚ã€è‡´ã—æ–¹ã®ãªã„ã“ã¨ã ã¨è¨€ãˆã¾ã™ã€‚

### `useState`

`useState`ã¯flutter_hooksã®ä¸­ã§ã‚‚ã€ç‰¹ã«åˆ©ç”¨ã•ã‚Œã‚‹hookã§ã™ã€‚ä¸€æ–¹ã§ç®¡ç†ã™ã‚‹å€¤ãŒæ›´æ–°ã•ã‚ŒãŸéš›ã€`build`ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹hookã§ã‚‚ã‚ã‚Šã¾ã™ã€‚
`HookState`ã®ç†è§£ã‚’æ·±ã‚ã‚‹ãŸã‚ã«ã‚‚ã€`useState`ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/primitives.dart#L267-L301

`useState`ãƒ¡ã‚½ãƒƒãƒ‰ã¯`use`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚`use`ã®å¼•æ•°ã«ã¯`Hook`ã‚’ç¶™æ‰¿ã—ãŸ`_StateHook`ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚å­—é¢ã¯ã‚„ã‚„ã“ã—ã„ã®ã§ã™ãŒã€ã“ã®`_StateHook`ã¯`StatefulWidget`ã®`StatefulWidget`ã‚¯ãƒ©ã‚¹ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ã™ã€‚
`_StateHook.createState()`ã¯`HookState`ã‚’ç¶™æ‰¿ã—ãŸ`_StateHookState`ã‚’è¿”å´ã—ã¾ã™ã€‚ã“ã®`_StateHookState`ãŒ`StatefulWidget`ã®`State`ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ã™ã€‚å…ˆã®`_createHookState`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¦ã€ã“ã®`createState`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã€`HookElement._hooks`ã«ä¿æŒã•ã‚Œã¾ã™ã€‚

çµæœã€è¦‹ã‚‹ã¹ãã¯æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```dart
class _StateHookState<T> extends HookState<ValueNotifier<T>, _StateHook<T>> {
  late final _state = ValueNotifier<T>(hook.initialData)
    ..addListener(_listener);

  @override
  void dispose() {
    _state.dispose();
  }

  @override
  ValueNotifier<T> build(BuildContext context) => _state;

  void _listener() {
    setState(() {});
  }

  @override
  Object? get debugValue => _state.value;

  @override
  String get debugLabel => 'useState<$T>';
}
```

ã“ã“ã§æ³¨æ„ãŒå¿…è¦ãªã®ã¯ã€`setState`ã§ã™ã€‚`HookState`ã¯`State`ã§ã¯ãªã„ãŸã‚ã€å³å¯†ã«ã¯(æˆ‘ã€…ãŒãƒ‘ãƒƒã¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã™ã‚‹)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚`HookState`ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

https://github.com/rrousselGit/flutter_hooks/blob/flutter_hooks-v0.21.0/packages/flutter_hooks/lib/src/framework.dart#L306-L313

å¼•æ•°ã§å–ã£ãŸfunctionã‚’å®Ÿè¡Œã—ãŸã®ã¡ã«ã€`_isOptionalRebuild`ã«`false`ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã®å‡¦ç†ã¯ã€ç›´å‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã›ãšã€æ–°è¦ã«`build`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãªãŠ`HookState.markMayNeedRebuild`ã‚’å‘¼ã³å‡ºã™hookãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã¯ã€ã“ã®é™ã‚Šã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚^[ã“ã‚Œã¯`HookState.markMayNeedRebuild`ãŒå¼·åŠ›ã™ãã‚‹ã¨æ€ã„ã¾ã™]

`HookState.setState`ã«ã¦`markNeedsBuild`ã‚’å‘¼ã³å‡ºã™ã®ã¯ã€`State`ã®`setState`ã¨åŒã˜ã§ã™ã€‚ã©ã¡ã‚‰ã‚‚`ComponentElement`ã®`markNeedsBuild`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã€ã‚ˆã†ã‚„ãé€šå¸¸ã®Widgetã«é–¢ã™ã‚‹ç†è§£ã¨è©±ãŒã¤ãªãŒã‚Šã¾ã™ã€‚

https://github.com/flutter/flutter/blob/3.24.0/packages/flutter/lib/src/widgets/framework.dart#L1163-L1224

`ValueNotifier`ã¯setã•ã‚ŒãŸå€¤ãŒåŒä¸€ã§ãªã„å ´åˆã€listenerã‚’å‘¼ã³å‡ºã™ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚çµæœã€`useState<T>`ã§ä½œã‚Šå‡ºã—ãŸ`ValueNotifier<T>`ã®å€¤ã‚’æ›´æ–°ã™ã‚‹ã¨ã€Widgetã®ãƒªãƒ“ãƒ«ãƒ‰ãŒèµ°ã‚ŠUIã«å€¤ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚

## ã¾ã¨ã‚

flutter_hooksã¯ã€Flutterã®ä»•çµ„ã¿ã‚’ç†è§£ã—ãŸä¸Šã§ã€`ComponentElement`ã‚’hookç”¨ã«æ‹¡å¼µã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ãªãŠã€[hooks_riverpod](https://pub.dev/packages/hooks_riverpod)ã‚‚`ConsumerStatefulWidget`ãªã©ã«`HookElement`ã‚’mixinã™ã‚‹ã“ã¨ã§å®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚
å®Ÿè£…ã‚’è¿½ã£ã¦ã¿ã‚‹ã¨ã€`HookElement`ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€`HookState`ã‚’é©åˆ‡ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`HookState`ã¯ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãªåˆ©ç”¨ã‚’ã™ã‚‹é™ã‚Šã¯ã€`State`ã®çŸ¥è­˜ãŒã‚ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ç´°ã‹ãªèª¿æ•´ã‚’è©¦ã¿ã‚‹å ´åˆã«ã¯ã€`HookElement`ã®ç†è§£ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

## ãŠã¾ã‘

flutter_hooksã®å®Ÿè£…ã‚’çŸ¥ã£ã¦ãŠãã¨ã€æ¬¡ã®IssueãŒç†è§£ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚è­°è«–ãŒã‚ªãƒ¼ãƒ—ãƒ³ãªã®ã¯å¬‰ã—ã„ã§ã™ã­ã€‚

https://github.com/flutter/flutter/issues/25280
