---
title: "PrimaryScrollControllerã¨StatefulShellRouteã®çµ„ã¿åˆã‚ã›"
emoji: "ğŸ“œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [
    "flutter",
    "primaryscrollcontroller",
    "inheritedwidget",
    "notificationlistener",
]
published: false
---

https://github.com/FlutterKaigi/conference-app-2023/pull/246

ã“ã¡ã‚‰ã®PRã§å¯¾å¿œã—ãŸå†…å®¹ã¨ã€ãªãœãã†ã—ãŸã®ã‹ã®ãƒ¡ãƒ¢ã€‚

## å‰æ

iOSã«ãŠã„ã¦ã€status baré ˜åŸŸ(å·¦ä¸Šã®æ™‚è¨ˆãªã©)ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒªã‚¹ãƒˆãŒ`position: 0`ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã‚Œã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®æ©Ÿèƒ½ã‚’Flutterã§å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€`PrimaryScrollController`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

https://api.flutter.dev/flutter/widgets/PrimaryScrollController-class.html

`PrimaryScrollController`ã¨`CustomScrollView`ã‚„`ListView`ã€`SingleChildScrollView`ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã«ã¯ã€2ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

1. `primary`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’`true`ã«ã™ã‚‹
2. `PrimaryScrollController.of(context)`ã§å–å¾—ã—ãŸcontrollerã‚’ã‚»ãƒƒãƒˆã™ã‚‹

`primary`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å ´åˆã€`ScrollView`ã‚¯ãƒ©ã‚¹ã®å†…éƒ¨ã§ã€`PrimaryScrollController.of(context)`ã§å–å¾—ã—ãŸcontrollerã‚’ã‚»ãƒƒãƒˆã™ã‚‹å‹•ãã«ãªã£ã¦ã„ã¾ã™ã€‚

https://github.com/flutter/flutter/blob/3.13.9/packages/flutter/lib/src/widgets/scroll_view.dart#L456-L461

## å•é¡Œ

https://github.com/flutter/flutter/issues/85603#issuecomment-876798161

è­°è«–ã«ä¸ŠãŒã£ã¦ã„ã‚‹è©±é¡Œã¨ã—ã¦ã¯ã€NavigatorãŒãƒã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€æ„å›³ã—ãŸ`PrimaryScrollController`ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚`PrimaryScrollController`ãŒ`ModalRoute`ã”ã¨ã«ç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ãŒåŸå› ã§ã™ã€‚(ç­†è€…ã®ç†è§£ã¨ã—ã¦ã¯ã€ç”»é¢ãŒpushã•ã‚ŒãŸæ™‚ã«ã€æ–°ãŸã«è¡¨ç¤ºã•ã‚ŒãŸç”»é¢ç”¨ã®`PrimaryScrollController`ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ãŸã®ã‹ãªã¨ã€‚)

ã¾ãŸã€FlutterKaigi 2023ã‚¢ãƒ—ãƒªã§ã¯ã€`StatefulShellRoute`ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

https://pub.dev/documentation/go_router/latest/go_router/StatefulShellRoute-class.html

ã“ã®`StatefulShellRoute`ã¯ã€`StatefulShellRoute`ã®sub routesã§Navigatorã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ä»•çµ„ã¿ã§ã™ã€‚çµæœã¨ã—ã¦ã€ç”»é¢å…¨ä½“(`Scaffold`ã‚’ç®¡ç†ã—ã¦ã„ã‚‹Navigator)ã¨`ListView`ç­‰(sub routeã¨ã—ã¦ç®¡ç†ã•ã‚ŒãŸNavigator)ã®é–“ã§ã€`PrimaryScrollController`ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## å¯¾å¿œ

`StatefulShellRouter`ã§å¯¾å¿œã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã‚‹ã¨ã€ã„ãã¤ã‹ã®å¯¾å¿œæ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ç­†è€…ã¨ã—ã¦ã¯ã€ã“ã“ã§ã¯ã€ŒFlutterã®Widget treeä¸Šã®å•é¡Œãªã®ã§ã€Flutterã®Widgetã‚’ä½¿ã£ã¦è§£æ±ºã™ã‚‹ã€æ–¹å‘ã§é€²ã‚ãŸã„ã§ã™ã€‚ã“ã®ãŸã‚ã€å¤§ãã2ã¤ã®æ¡ˆãŒæ€ã„ä»˜ãã¾ã™ã€‚`InheritedWidget`ã‚’åˆ©ç”¨ã™ã‚‹æ¡ˆ(parent to child)ã¨ã€`NotificationListener`ã‚’åˆ©ç”¨ã™ã‚‹æ¡ˆ(child to parent)ã§ã™ã€‚

### `InheritedWidget`ã‚’åˆ©ç”¨ã™ã‚‹æ¡ˆ

`Scaffold`ã‚’ç®¡ç†ã—ã¦ã„ã‚‹NavigatorãŒstatus barã¨é€£æºã—ã¦ã„ã‚‹ã®ã§ã€ãã®`PrimaryScrollController`ã‚’bodyéƒ¨ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã„ã„ã®ã§ã€æ¬¡ã®ã‚ˆã†ãª`InheritedWidget`ã‚’ä½œæˆã—ã¾ã™ã€‚

```dart
class RootPrimaryScrollController extends InheritedWidget {
  const RootPrimaryScrollController({
    required this.controller,
  }):

  final ScrollController controller;

  static RootPrimaryScrollController? maybeOf(BuildContext context) {
    return context.dependOnInheritedWidgetOfExactType<RootPrimaryScrollController>();
  }

  static RootPrimaryScrollController of(BuildContext context) {
    final RootPrimaryScrollController? result = maybeOf(context);
    assert(result != null, 'No RootPrimaryScrollController found in context');
    return result!;
  }

  @override
  bool updateShouldNotify(RootPrimaryScrollController oldWidget) => controller != oldWidget.controller;
}
```

ç¶šã„ã¦ã€rootã§æ¬¡ã®ã‚ˆã†ã«`PrimaryScrollController`ã‚’é…å¸ƒã—ã¾ã™ã€‚

```dart
return RootPrimaryScrollController(
  controller: PrimaryScrollController.of(context),
  child: Scaffold(),
);
```

æœ€å¾Œã«ã€`ListView`ãªã©ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã§ `RootPrimaryScrollController.of(context)!.controller;`ã‚’å‘¼ã³å‡ºã›ã°ã€rootç”»é¢ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹`PrimaryScrollController`ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

### `NotificationListener`ã‚’åˆ©ç”¨ã™ã‚‹æ¡ˆ

è¡¨ç¤ºä¸­ã®`ListView`ç­‰ã«é–¢é€£ã¥ã‘ã‚‰ã‚Œã¦ã„ã‚‹`PrimaryScrollController`ãŒ`Scaffold`ã§åˆ©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Œã°è‰¯ã„ã¯ãšã§ã™ã€‚
ã“ã®ä»•çµ„ã¿ã‚’ã€`NotificationListener`ã‚’åˆ©ç”¨ã—ã¦å®Ÿç¾ã—ã¾ã™ã€‚

ã¾ãšã€`NotificationListener`ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€`ScrollControllerNotification`ã‚’å®šç¾©ã—ã¾ã™ã€‚

```dart
class ScrollControllerNotification extends Notification {
  const ScrollControllerNotification({
    required this.controller,
  });

  final ScrollController controller;
}
```

ç¶šã„ã¦ã€rootã®ç”»é¢ã‚’`StatefulWidget`ã«å¤‰æ›´ã—ã€æ¬¡ã®ã‚ˆã†ãªå®Ÿè£…ã«ã—ã¾ã™ã€‚

```dart
class _RootScreenState extends State<RootScreen> {
  ScrollController? _primaryScrollController;

  @override
  Widget build(BuildContext context) {
    return NotificationListener<ScrollControllerNotification>(
      onNotification: (notification) {
        if (_primaryScrollController != notification.controller) {
          setState(() {
            _primaryScrollController = notification.controller;
          });
        }

        return true;
      },
      child: PrimaryScrollController(
        controller: _primaryScrollController ?? PrimaryScrollController.of(context),
```

æœ€å¾Œã«ã€`ListView`ãªã©ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã§ã€`ScrollControllerNotification.dispatch`ã‚’è¡Œã„ã¾ã™ã€‚
PRã§ã¯ã€`build`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯æ„å›³ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç™ºç«ã—ãªã„ã“ã¨ãŒã‚ã‹ã£ãŸã®ã§ã€`visibility_detector`ã‚’åˆ©ç”¨ã—ã€ŒWidgetãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ã€ã«ç™ºç«ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

https://pub.dev/packages/visibility_detector

æ•°ã‚«æ‰€ã§åˆ©ç”¨ã™ã‚‹ã®ã§ã€æ¬¡ã®ã‚ˆã†ãªWrapper Widgetã‚’ä½œæˆã—ã¾ã™ã€‚

```dart
class VisibleDetectScrollControllerNotifier extends StatelessWidget {
  const VisibleDetectScrollControllerNotifier({
    super.key,
    required this.visibleDetectorKey,
    required this.child,
  });

  final Key visibleDetectorKey;
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return VisibilityDetector(
      key: visibleDetectorKey,
      onVisibilityChanged: (info) {
        if (info.visibleFraction == 1) {
          ScrollControllerNotification(
            controller: PrimaryScrollController.of(context),
          ).dispatch(context);
        }
      },
      child: child,
    );
  }
}
```

æœ€å¾Œã«ã€`ListView`ãªã©ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã§ã€`VisibleDetectScrollControllerNotifier`ã§ãƒ©ãƒƒãƒ— + `primary`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’`true`ã«ã™ã‚‹ã“ã¨ã§ã€`PrimaryScrollController`ãŒåˆ©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```dart
class SubRoutePage extends StatelessWidget {
  const SubRoutePage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return VisibleDetectScrollControllerNotifier(
      visibleDetectorKey: const Key('SubRoutePage'),
      child: ListView(
        primary: true,
```

### å¯¾å¿œæ¡ˆã®æ¯”è¼ƒ

2ã¤ã®æ¡ˆã¯ã€æ‰‹å…ƒã§è©¦ã™é™ã‚Šã§ã¯ã€ã©ã¡ã‚‰ã‚‚æœŸå¾…é€šã‚Šã®å‹•ãã‚’ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚
å”¯ä¸€é•ã†ã®ã¯ã€**å˜ä¸€ã®**`PrimaryScrollController`ãŒã™ã¹ã¦ã®`ListView`ã§åˆ©ç”¨ã•ã‚Œã‚‹ã‹ã€é€†ã«ã€`ListView`ã”ã¨ã«`PrimaryScrollController`ãŒåˆ©ç”¨ã•ã‚Œã‚‹ã‹ã€ã¨ã„ã†ç‚¹ã§ã™ã€‚

`StatefulShellRoute`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å¾—ã‚‰ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€å„sub routeã®çŠ¶æ…‹ã‚’ä¿æŒã§ãã‚‹ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®ãŸã‚ã€å¯èƒ½ã§ã‚ã‚Œã°ã€`ListView`ã”ã¨ã«ã€Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã€ã¯ä¿æŒã•ã‚Œã¦ã„ã‚‹æ–¹ãŒè‰¯ã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚ã“ã®ç‚¹ã«ãŠã„ã¦ã€`NotificationListener`ã‚’åˆ©ç”¨ã™ã‚‹æ¡ˆã®æ–¹ãŒã€`StatefulShellRoute`ã®ãƒ¡ãƒªãƒƒãƒˆã‚’æ´»ã‹ã›ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

## ãŠã‚ã‚Šã«

`PrimaryScrollController`ã¨`StatefulShellRoute`ã®çµ„ã¿åˆã‚ã›ã«ãŠã„ã¦ã€`PrimaryScrollController`ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ãªã„å•é¡Œã«ã¤ã„ã¦ã€2ã¤ã®å¯¾å¿œæ¡ˆã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
FlutterKaigi 2023ã‚¢ãƒ—ãƒªã§ã¯ã€è‰²ã€…ã¨å®Ÿé¨“çš„ã«è©¦ã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒå¤šã„ã®ã§ã€ã“ã®ã‚ˆã†ãªå•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã®ã‚ˆã†ãªå•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã«ã¯ã€ãœã²Issueã‚„PRã‚’ä½œæˆã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

2023å¹´11æœˆ10æ—¥ã‚’ãŠãŸã®ã—ã¿ã«ï¼
