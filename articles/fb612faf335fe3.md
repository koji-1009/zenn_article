---
title: "flutter_secure_storageã‚’èª­ã‚€"
emoji: "ğŸ”’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [
    "flutter",
]
published: true
published_at: "2023-12-13 09:00"
---

Flutterã§ãƒ‡ãƒ¼ã‚¿ã‚’**ã‚»ã‚­ãƒ¥ã‚¢**ã«ä¿å­˜ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€flutter_secure_storageã‚’ä½¿ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

https://pub.dev/packages/flutter_secure_storage

flutter_secure_storageã¯ã€ŒiOSã§ã¯Keychainã€Androidã§ã¯KeyStoreã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã¨èª¬æ˜ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã¯ãªã„ã®ã§ã—ã‚‡ã†ã‹ã€‚ãƒãƒ©ãƒƒã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ãŸã¨ã“ã‚ã€èª­ã¿ã“ãªã›ãªã„é‡ã§ã¯ãªã•ãã†ã ã£ãŸã®ã§ã€Androidã¨iOSã€ãã—ã¦Webã§ã©ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã„ã‚‹ã®ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚

è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã®flutter_secure_storageã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€`9.0.0`ã§ã™ã€‚

https://github.com/mogol/flutter_secure_storage/tree/v9.0.0/flutter_secure_storage

## Android

Androidã®å ´åˆã€EncryptedSharedPreferencesã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹æ–¹æ³•ã¨ã€SharedPreferencesã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

https://developer.android.com/reference/androidx/security/crypto/EncryptedSharedPreferences

EncryptedSharedPreferencesã¯Android 23ä»¥ä¸Šã§åˆ©ç”¨ã§ãã‚‹ã€SharedPreferencesã‚’æš—å·åŒ–ã—ã¦ä¿å­˜ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚ãŸã ä»Šå›ã¯ã€**EncryptedSharedPreferencesã‚’åˆ©ç”¨ã—ãªã„**ã‚±ãƒ¼ã‚¹ã‚’ä¸»ã«ç¢ºèªã—ã¾ã™ã€‚

### EncryptedSharedPreferencesã®ã‚±ãƒ¼ã‚¹ã‚’è¦‹ãªã„ç†ç”±

ä»¥ä¸‹ã®2ã¤ãŒä¸»ãªç†ç”±ã§ã™ã€‚

1. EncryptedSharedPreferencesãŒãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹æã‚ŒãŒã‚ã‚‹
2. androidx.security.cryptoã®å„APIãŒdeprecatedã«ãªã‚‹è¦‹è¾¼ã¿ãŒã‚ã‚‹

#### EncryptedSharedPreferencesãŒãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹æã‚ŒãŒã‚ã‚‹

https://stackoverflow.com/questions/73784634/caused-by-com-google-crypto-tink-shaded-protobuf-invalidprotocolbufferexception

ã“ã¡ã‚‰ã®StackOverflowã®è³ªå•ã«ã‚ã‚‹ã‚ˆã†ã«ã€EncryptedSharedPreferencesã‚’åˆ©ç”¨ã™ã‚‹ã¨ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å•é¡Œã¯ã€ä»¥ä¸‹ã®Issueã§å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

https://issuetracker.google.com/issues/164901843

ã“ã®å•é¡Œã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å†…éƒ¨ã«å­˜åœ¨ã™ã‚‹ã‚‚ã®ã§ã‚ã‚‹ãŸã‚ã€åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªå´ã§å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
å•é¡ŒãŒè§£æ¶ˆã•ã‚Œã‚‹è¦‹è¾¼ã¿ãŒç«‹ã£ã¦ã„ãªã„ãŸã‚ã€EncryptedSharedPreferencesã‚’åˆ©ç”¨ã™ã‚‹ä¸€ã¤ã®ãƒªã‚¹ã‚¯ã«ãªã£ã¦ã„ã¾ã™ã€‚ç‰¹ã«Flutterã®å ´åˆã«ã¯ã€EncreyptedSharedPreferencesã‚’flutter_secure_storageãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµŒç”±ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ãŸã‚ã€å¯¾å¿œãŒé›£ã—ããªã£ã¦ã„ã¾ã™ã€‚
(ã¾ãŸã€å¾Œè¿°ã®ç†ç”±ã«ã‚ˆã‚Šã€ã“ã®å•é¡ŒãŒè§£æ¶ˆã•ã‚Œã‚‹è¦‹è¾¼ã¿ã¯ãã“ã¾ã§é«˜ãã‚ã‚Šã¾ã›ã‚“)

#### androidx.security.cryptoã®å„APIãŒdeprecatedã«ãªã‚‹è¦‹è¾¼ã¿ãŒã‚ã‚‹

å…ˆæ—¥Twitterã§è©±é¡Œã«ãªã£ã¦ã„ãŸä»¶ã§ã™ã€‚
è©³ç´°ã¯ã€ä¸‹è¨˜ã®gerritãŒå¯¾å¿œã‚’è¡Œã£ãŸcommitã«ãªã‚‹ãŸã‚ã€æœ€ã‚‚å‚è€ƒã«ãªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

https://android-review.googlesource.com/c/platform/frameworks/support/+/2761067

æœªã ã«æ­£å¼ãªç™ºè¡¨ã«è‡³ã£ãŸã‚ã‘ã§ã¯ãªã„ã®ã§ã™ãŒã€æ¬¡ã®æ–‡ç« ãŒå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã•ã‚ŒãŸä»¥ä¸Šã€éæ¨å¥¨ã«ãªã£ãŸã¨ã¿ãªã—ã¦è‰¯ã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚

> Jetpack Security Crypto ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯éæ¨å¥¨ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒª ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® build.gradle ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¬¡ã®ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã«ã®ã¿å½±éŸ¿ã—ã¾ã™ã€‚

https://developer.android.com/guide/topics/security/cryptography?hl=ja#jetpack_security_crypto_library

---

ç­†è€…ã®ç†è§£ã¨ã—ã¦ã¯ã€ã“ã‚Œã¯ã€ŒAndroidã®å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯ã€åŸºæœ¬çš„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã¯å®‰å…¨ã§ã‚ã‚‹ã€ã¨ã„ã†å‰æã«ç«‹ã¡è¿”ã£ãŸã‚‚ã®ã ã¨æ€ã‚ã‚Œã¾ã™ã€‚
å…ˆã»ã©ã®gerritã®[ã‚³ãƒ¡ãƒ³ãƒˆ](https://android-review.googlesource.com/c/platform/frameworks/support/+/2761067/3#message-2f3ebd06b05139fb1e2f0b3105028b52ac689d50)ã§ã€æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®å‚ç…§ãŒã‚ã‚Šã¾ã™ã€‚

https://developer.android.com/privacy-and-security/security-tips?hl=ja#InternalStorage

> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¸Šã«ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã®ã¯ã€ä½œæˆå…ƒã®ã‚¢ãƒ—ãƒªã«é™ã‚‰ã‚Œã¾ã™ã€‚Android ã¯ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  ãƒ¬ãƒ™ãƒ«ã§ã“ã®ä¿è­·æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€ã»ã¨ã‚“ã©ã®ã‚¢ãƒ—ãƒªã¯ã“ã®æ©Ÿèƒ½ã§ååˆ†ã§ã™ã€‚

ã“ã‚Œã¾ã§ã®**ã‚»ã‚­ãƒ¥ã‚¢**ãªå–ã‚Šçµ„ã¿ã«åã™ã‚‹ã‚ˆã†ã§ã™ãŒã€ç¢ºã‹ã«ã€Androidã®å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚¢ãƒ—ãƒªãŒä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½œæˆå…ƒã®ã‚¢ãƒ—ãƒªã«é™ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚(Androidã‚’æ”¯ãˆã‚‹æŠ€è¡“ã€ˆâ…¡ã€‰ãŒè©³ã—ã„ã§ã™ã€‚)

https://gihyo.jp/book/2017/978-4-7741-8861-4

---

å¯¾å¿œã«è‡³ã£ãŸç†ç”±ã®Issueã«ã¯ã€ç¾åœ¨ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ã‚ˆã£ã¦ã€ã“ã®å¯¾å¿œã®èƒŒæ™¯ã«ã¤ã„ã¦ã¯ã€ç¾æ™‚ç‚¹ã§ã¯è©³ç´°ãŒä¸æ˜ã§ã™ã€‚

https://issuetracker.google.com/issues/301997816

ä»¥ä¸‹ã¯ã€ç­†è€…ãŒã€Œã“ã‚“ãªã¨ã“ã‚ãªã®ã‹ãªãã€ã¨æ€ã£ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

Androidã®å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒçªç ´ã•ã‚Œã‚‹ã®ã¯ã€ç­†è€…ã®ç†è§£ã§ã¯ã€rootåŒ–ã•ã‚ŒãŸç«¯æœ«ã§ã‚ã£ãŸã‚Šã€ç«¯æœ«ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒçªç ´ã•ã‚ŒãŸç«¯æœ«ã§ã™ã€‚å‰è€…ã¯åŸºæœ¬çš„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å«ã¾ã‚Œãªã„åˆ¤æ–­ãŒã€‚å¾Œè€…ã¯ã€Œç«¯æœ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒçªç ´ã•ã‚ŒãŸã€æ™‚ç‚¹ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æš—å·åŒ–ã—ã¦å¯¾å¿œã§ãã‚‹ä»¥ä¸Šã®å•é¡Œãªã®ã§ã¯ãªã„ã‹ãªã¨ã€‚

ã¾ãŸã€EncryptedSharedPreferencesã«ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„ç«¯æœ«é–“ã®ç§»å‹•ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ã“ã†ã„ã£ãŸæ©Ÿèƒ½çš„ã«åˆ¶é™ã•ã‚Œã‚‹çŠ¶æ³ãŒã‚ã‚‹ãŸã‚ã€EncryptedSharedPreferencesã‚’ã¯ã˜ã‚ã¨ã—ã¦ã€androidx.security.cryptoã®APIãŒdeprecatedã«ãªã£ãŸã®ã§ã¯ãªã„ã‹ã€ã¨æƒ³åƒã—ã¦ã„ã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€ã€ŒAndroidã‚¢ãƒ—ãƒªãŒä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã€æš—å·åŒ–ã—ãŸæ–¹ãŒè‰¯ã„ã€ã¨ã„ã†æ„è¦‹ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®**androidx.security.cryptoã‚’ä½¿ã‚ãš**ã«**ä¿å­˜ã™ã‚‹å€¤ã‚’æš—å·åŒ–ã—ã¦ã„ã‚‹**ã®ãŒã€flutter_secure_storageã®`encryptedSharedPreferences: false`ã®ã‚±ãƒ¼ã‚¹ã§ã™ã€‚

### SharedPreferences + StorageCipher + KeyCipher

EncryptedSharedPreferencesã‚’åˆ©ç”¨ã—ãªã„å ´åˆã€SharedPreferencesã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€æš—å·åŒ–ã‚’è¡Œã†ãŸã‚ã«ã€StorageCipherã‚¯ãƒ©ã‚¹ã‚’flutter_secure_storageã§ã¯å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã€ç°¡å˜ã«å‡¦ç†ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

#### StorageCipher

ä¿å­˜ç”¨ã®SharedPreferencesã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã—ã¦ã„ã‚‹ç®‡æ‰€ã‹ã‚‰ã€ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã®ãŒã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚ã“ã®ãŸã‚ã€ã¡ã‚‡ã£ã¨é•·ããªã‚‹ã®ã§ã™ãŒã€é †ã€…ã«ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¾ã™ã€‚

`read`ã‚„`delete`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€æœ€åˆã«`ensureInitialized`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚
å¾Œã»ã©ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã‚‹ãƒªãƒ³ã‚¯ã‚’è²¼ã‚‹ã®ã§ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å¼•ç”¨ã™ã‚‹éš›ã«ã¯ã€ä¸€éƒ¨ã®å‡¦ç†ã‚’çœç•¥ã—ã¦ã„ã¾ã™ã€‚

```java
private void ensureInitialized() {
    SharedPreferences nonEncryptedPreferences = applicationContext.getSharedPreferences(
            SHARED_PREFERENCES_NAME,
            Context.MODE_PRIVATE
    );
    if (storageCipher == null) {
        try {
            initStorageCipher(nonEncryptedPreferences);

        } catch (Exception e) {
            Log.e(TAG, "StorageCipher initialization failed", e);
        }
    }
    if (getUseEncryptedSharedPreferences() && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        try {
            preferences = initializeEncryptedSharedPreferencesManager(applicationContext);
            checkAndMigrateToEncrypted(nonEncryptedPreferences, preferences);
        } catch (Exception e) {
            Log.e(TAG, "EncryptedSharedPreferences initialization failed", e);
            preferences = nonEncryptedPreferences;
            failedToUseEncryptedSharedPreferences = true;
        }
    } else {
        preferences = nonEncryptedPreferences;
    }
}

private void initStorageCipher(SharedPreferences source) throws Exception {
    storageCipherFactory = new StorageCipherFactory(source, options);
    if (getUseEncryptedSharedPreferences()) {
        storageCipher = storageCipherFactory.getSavedStorageCipher(applicationContext);
    } else if (storageCipherFactory.requiresReEncryption()) {
        reEncryptPreferences(storageCipherFactory, source);
    } else {
        storageCipher = storageCipherFactory.getCurrentStorageCipher(applicationContext);
    }
}
```

EncryptedSharedPreferencesã‚’æœ‰åŠ¹ã«ã—ãªã‹ã£ãŸã‚±ãƒ¼ã‚¹ã§ã¯ã€ä»¥ä¸‹ã®å‡¦ç†ãŒå®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
(ãªãŠã€EncryptedSharedPreferencesã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã“ã“ã§ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã¯çµ‚äº†ã¨ãªã‚Šã¾ã™ã€‚)

```java
private void ensureInitialized() {
    SharedPreferences nonEncryptedPreferences = applicationContext.getSharedPreferences(
            SHARED_PREFERENCES_NAME,
            Context.MODE_PRIVATE
    );
    if (storageCipher == null) {
        try {
            initStorageCipher(nonEncryptedPreferences);

        } catch (Exception e) {
            Log.e(TAG, "StorageCipher initialization failed", e);
        }
    }

    preferences = nonEncryptedPreferences;
}

private void initStorageCipher(SharedPreferences source) throws Exception {
    storageCipherFactory = new StorageCipherFactory(source, options);
    storageCipher = storageCipherFactory.getCurrentStorageCipher(applicationContext);
}
```

ã“ã®ãŸã‚ã€`storageCipher`ã«ä½•ãŒå…¥ã£ã¦ã„ã‚‹ã‹ãŒå•é¡Œã«ãªã‚Šã¾ã™ã€‚ã¨ã„ã†ã®ã‚‚`write`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€ã“ã®`storageCipher`ã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã—ã¦ãŠã‚Šã€`read`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€ã“ã®`storageCipher`ã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

```java
void write(String key, String value) throws Exception {
    ensureInitialized();

    SharedPreferences.Editor editor = preferences.edit();

    if (getUseEncryptedSharedPreferences()) {
        editor.putString(key, value);
    } else {
        byte[] result = storageCipher.encrypt(value.getBytes(charset));
        editor.putString(key, Base64.encodeToString(result, 0));
    }
    editor.apply();
}

String read(String key) throws Exception {
    ensureInitialized();

    String rawValue = preferences.getString(key, null);
    if (getUseEncryptedSharedPreferences()) {
        return rawValue;
    }
    return decodeRawValue(rawValue);
}

private String decodeRawValue(String value) throws Exception {
    if (value == null) {
        return null;
    }
    byte[] data = Base64.decode(value, 0);
    byte[] result = storageCipher.decrypt(data);

    return new String(result, charset);
}
```

ã§ã¯æ¬¡ã«`getCurrentStorageCipher`ã®å‡¦ç†ã‚’è¦‹ãŸã„ã®ã§ã™ãŒã€ãã®å‰ã«`StorageCipherFactory`ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```java
public StorageCipherFactory(SharedPreferences source, Map<String, Object> options) {
    savedKeyAlgorithm = KeyCipherAlgorithm.valueOf(source.getString(ELEMENT_PREFERENCES_ALGORITHM_KEY, DEFAULT_KEY_ALGORITHM.name()));
    savedStorageAlgorithm = StorageCipherAlgorithm.valueOf(source.getString(ELEMENT_PREFERENCES_ALGORITHM_STORAGE, DEFAULT_STORAGE_ALGORITHM.name()));

    final KeyCipherAlgorithm currentKeyAlgorithmTmp = KeyCipherAlgorithm.valueOf(getFromOptionsWithDefault(options, "keyCipherAlgorithm", DEFAULT_KEY_ALGORITHM.name()));
    currentKeyAlgorithm = (currentKeyAlgorithmTmp.minVersionCode <= Build.VERSION.SDK_INT) ? currentKeyAlgorithmTmp : DEFAULT_KEY_ALGORITHM;
    final StorageCipherAlgorithm currentStorageAlgorithmTmp = StorageCipherAlgorithm.valueOf(getFromOptionsWithDefault(options, "storageCipherAlgorithm", DEFAULT_STORAGE_ALGORITHM.name()));
    currentStorageAlgorithm = (currentStorageAlgorithmTmp.minVersionCode <= Build.VERSION.SDK_INT) ? currentStorageAlgorithmTmp : DEFAULT_STORAGE_ALGORITHM;
}
```

flutter_secure_storageã§ã¯ã€ä»¥ä¸‹ã®2ã¤ã®enumãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

* KeyCipherAlgorithm
  * RSA_ECB_PKCS1Padding (Android 23æœªæº€)
  * **RSA_ECB_OAEPwithSHA_256andMGF1Padding** (Android 23ä»¥ä¸Š)
* StorageCipherAlgorithm
  * AES_CBC_PKCS7Padding (Android 23æœªæº€)
  * **AES_GCM_NoPadding** (Android 23ä»¥ä¸Š)

`StorageCipherFactory`ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯ã€å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹Android OSã«å¿œã˜ã¦Ciperã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚ã€‚
ãªãŠã€`options`ã«ã¯ã€`keyCipherAlgorithm`ã¨`storageCipherAlgorithm`ã®2ã¤ã®å€¤ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®å€¤ã¯ã€`AndroidOptions`ã§æŒ‡å®šå¯èƒ½ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€`RSA_ECB_PKCS1Padding`(KeyCipher)ã¨`AES_CBC_PKCS7Padding`(StorageCipher)ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
å¤§æŠµã®å ´åˆã€Android 23ä»¥ä¸ŠãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã§ã—ã‚‡ã†ã—ã€23æœªæº€ã§ã¯è‡ªå‹•çš„ã«å¤ã„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¸ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹ãŸã‚ã€å•é¡Œãªã„å‡¦ç†ã§ã™ã€‚

```java
public StorageCipher getCurrentStorageCipher(Context context) throws Exception {
    final KeyCipher keyCipher = currentKeyAlgorithm.keyCipher.apply(context);
    return currentStorageAlgorithm.storageCipher.apply(context, keyCipher);
}
```

ã“ã‚Œã‚‰ã‚’è¸ã¾ãˆã‚‹ã¨ã€`getCurrentStorageCipher`ã¯`AES_GCM_NoPadding`ã«å¯¾å¿œã™ã‚‹`StorageCipher`ãŒå¾—ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã‹ã¨æ€ã„ã¾ã™ã€‚å¯¾å¿œã™ã‚‹`KeyCiper`ã¯`RSACipherOAEPImplementation`ã§ã™ã€‚

```java
public StorageCipher18Implementation(Context context, KeyCipher rsaCipher) throws Exception {
    secureRandom = new SecureRandom();
    String aesPreferencesKey = getAESPreferencesKey();

    SharedPreferences preferences = context.getSharedPreferences(SHARED_PREFERENCES_NAME, Context.MODE_PRIVATE);
    SharedPreferences.Editor editor = preferences.edit();

    String aesKey = preferences.getString(aesPreferencesKey, null);

    cipher = getCipher();

    if (aesKey != null) {
        byte[] encrypted;
        try {
            encrypted = Base64.decode(aesKey, Base64.DEFAULT);
            secretKey = rsaCipher.unwrap(encrypted, KEY_ALGORITHM);
            return;
        } catch (Exception e) {
            Log.e("StorageCipher18Impl", "unwrap key failed", e);
        }
    }

    byte[] key = new byte[keySize];
    secureRandom.nextBytes(key);
    secretKey = new SecretKeySpec(key, KEY_ALGORITHM);

    byte[] encryptedKey = rsaCipher.wrap(secretKey);
    editor.putString(aesPreferencesKey, Base64.encodeToString(encryptedKey, Base64.DEFAULT));
    editor.apply();
}
```

ã§ã¯StorageCipherã®å®Ÿè£…ã‚’è¦‹ã‚‹ãâ€¦â€¦ã€ã¨èª­ã‚“ã§ã„ãã¨ã€ã€ŒãŠã‚„ï¼Ÿã€ã¨æ€ã†æ–¹ã‚‚ã„ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ã¨ã„ã†ã®ã‚‚ã€StorageCipherã§ã¯**SharedPreferencesã«seacretKeyã‚’ä¿å­˜ã—ã¦ã„ã‚‹**ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚è‚å¿ƒã®`getAESPreferencesKey`ã¯å®šæ•°ã®æ–‡å­—åˆ—ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€*ãœã„ã˜ã‚ƒã*ãªå®Ÿè£…ã®ã‚ˆã†ã§ã™ã€‚

---

å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ãŸã„æ–¹ã¯ã€ä¸‹ã®ãƒˆã‚°ãƒ«ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚

:::details å¼•ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰
`FlutterSecureStorage#ensureInitialized`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/android/src/main/java/com/it_nomads/fluttersecurestorage/FlutterSecureStorage.java#L135-L172

`FlutterSecureStorage#initStorageCipher`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/android/src/main/java/com/it_nomads/fluttersecurestorage/FlutterSecureStorage.java#L174-L183

`StorageCipherFactory`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/android/src/main/java/com/it_nomads/fluttersecurestorage/ciphers/StorageCipherFactory.java#L57-L65

`StorageCipherFactory#getCurrentStorageCipher`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/android/src/main/java/com/it_nomads/fluttersecurestorage/ciphers/StorageCipherFactory.java#L81-L84

`StorageCipher18Implementation`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/android/src/main/java/com/it_nomads/fluttersecurestorage/ciphers/StorageCipher18Implementation.java#L24-L53
:::

#### KeyCipher

ãã‚‚ãã‚‚KeyCipherã®å½¹å‰²ã¯ãªã‚“ãªã®ã‹ã€ã¨ã„ã†è©±ã«ç«‹ã¡è¿”ã‚Šã¾ã™ã€‚

```java
public StorageCipher18Implementation(Context context, KeyCipher rsaCipher) throws Exception {
    secureRandom = new SecureRandom();
    SharedPreferences.Editor editor = preferences.edit();

    String aesKey = preferences.getString(aesPreferencesKey, null);

    if (aesKey != null) {
        byte[] encrypted;
        try {
            encrypted = Base64.decode(aesKey, Base64.DEFAULT);
            secretKey = rsaCipher.unwrap(encrypted, KEY_ALGORITHM); // â‡¦ ã“ã“ã§unwrap
            return;
        } catch (Exception e) {
            Log.e("StorageCipher18Impl", "unwrap key failed", e);
        }
    }

    byte[] key = new byte[keySize];
    secureRandom.nextBytes(key);
    secretKey = new SecretKeySpec(key, KEY_ALGORITHM);

    byte[] encryptedKey = rsaCipher.wrap(secretKey); // â‡¦ ã“ã“ã§wrap
    editor.putString(aesPreferencesKey, Base64.encodeToString(encryptedKey, Base64.DEFAULT));
    editor.apply();
}
```

`StorageCipherFactory`ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‹ã‚‰ã€KeyChiperãŒã©ã®ã‚ˆã†ã«åˆ©ç”¨ã•ã‚Œã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã¨ã€**secretKeyã‚’Preferenceã«ä¿å­˜**ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€KeyChiperã¯**Preferenceã«ä¿å­˜ã•ã‚Œã‚‹ã€seacretKeyã‚’æš—å·åŒ–ã™ã‚‹ãŸã‚ã®Cipher**ã§ã™ã€‚

KeyChiperã«ã¯ã€2ã¤ã®å®Ÿè£…ãŒã‚ã‚Šã¾ã™ã€‚Android 23æœªæº€ç”¨ã®`RSACipher18Implementation`ã¨ã€23ä»¥ä¸Šç”¨ã®`RSACipherOAEPImplementation`ã§ã™ã€‚ç´°ã€…ã¨ã—ãŸå®Ÿè£…ã®é•ã„ã¯ã‚ã‚Šã¾ã™ãŒã€æ³¨ç›®ã™ã‚‹ã¹ãã¯ã€`AlgorithmParameterSpec`ã‚’ä½œã‚‹`makeAlgorithmParameterSpec`ãƒ¡ã‚½ãƒƒãƒ‰ã®é•ã„ã§ã™ã€‚

```java
class RSACipher18Implementation implements KeyCipher {
    // Flutter gives deprecation warning without suppress
    @SuppressWarnings("deprecation")
    private AlgorithmParameterSpec makeAlgorithmParameterSpecLegacy(Context context, Calendar start, Calendar end) {
        return new android.security.KeyPairGeneratorSpec.Builder(context)
                .setAlias(keyAlias)
                .setSubject(new X500Principal("CN=" + keyAlias))
                .setSerialNumber(BigInteger.valueOf(1))
                .setStartDate(start.getTime())
                .setEndDate(end.getTime())
                .build();
    }

    // ç­†è€…æ³¨: RSACipher18Implementationã§ã‚‚ã€Android 23ä»¥ä¸Šãªã‚‰ã°æ–°ã—ã„å‡¦ç†ã‚’ä½¿ã†ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
    @RequiresApi(api = Build.VERSION_CODES.M)
    protected AlgorithmParameterSpec makeAlgorithmParameterSpec(Context context, Calendar start, Calendar end) {
        final KeyGenParameterSpec.Builder builder = new KeyGenParameterSpec.Builder(keyAlias, KeyProperties.PURPOSE_DECRYPT | KeyProperties.PURPOSE_ENCRYPT)
                .setCertificateSubject(new X500Principal("CN=" + keyAlias))
                .setDigests(KeyProperties.DIGEST_SHA256)
                .setBlockModes(KeyProperties.BLOCK_MODE_ECB)
                .setEncryptionPaddings(KeyProperties.ENCRYPTION_PADDING_RSA_PKCS1)
                .setCertificateSerialNumber(BigInteger.valueOf(1))
                .setCertificateNotBefore(start.getTime())
                .setCertificateNotAfter(end.getTime());
        return builder.build();
    }
}

public class RSACipherOAEPImplementation extends RSACipher18Implementation {
    @RequiresApi(api = Build.VERSION_CODES.M)
    @Override
    protected AlgorithmParameterSpec makeAlgorithmParameterSpec(Context context, Calendar start, Calendar end) {
        final KeyGenParameterSpec.Builder builder = new KeyGenParameterSpec.Builder(keyAlias, KeyProperties.PURPOSE_DECRYPT | KeyProperties.PURPOSE_ENCRYPT)
                .setCertificateSubject(new X500Principal("CN=" + keyAlias))
                .setDigests(KeyProperties.DIGEST_SHA256)
                .setBlockModes(KeyProperties.BLOCK_MODE_ECB)
                .setEncryptionPaddings(KeyProperties.ENCRYPTION_PADDING_RSA_OAEP)
                .setCertificateSerialNumber(BigInteger.valueOf(1))
                .setCertificateNotBefore(start.getTime())
                .setCertificateNotAfter(end.getTime());
        return builder.build();
    }
}
```

Android 23æœªæº€ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã¯`KeyPairGeneratorSpec`ã§ã™ã€‚Android 23ã§deprecatedã«ãªã£ã¦ã„ã¾ã™ã€‚
Android 23ä»¥ä¸Šã§ã¯ã€`KeyGenParameterSpec`ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://developer.android.com/reference/android/security/KeyPairGeneratorSpec

https://developer.android.com/reference/android/security/keystore/KeyGenParameterSpec

ã“ã®2ã¤ã®é•ã„ã¯ã€**ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ ¼ç´å‹ã‚­ãƒ¼ã‚¹ãƒˆã‚¢**ã‚’åˆ©ç”¨ã™ã‚‹ã‹ã©ã†ã‹ã§ã™ã€‚ç­†è€…ã®ã–ã£ãã‚Šã¨ã—ãŸç†è§£ã§ã¯ã€`android.security.keystore`é…ä¸‹ã®APIã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Androidç«¯æœ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ãŸé ˜åŸŸã«éµã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€éµã‚’å¤–éƒ¨ã‹ã‚‰å–å¾—ã™ã‚‹ã“ã¨ãŒã€éå¸¸ã«é›£ã—ããªã‚Šã¾ã™ã€‚

https://source.android.com/docs/security/features/keystore?hl=ja

çµæœã¨ã—ã¦ã€Android 23ä»¥ä¸Šã®ç«¯æœ«ã§ã¯ã€EncryptedSharedPreferencesã‚’åˆ©ç”¨ã—ãªã„ã‚±ãƒ¼ã‚¹ã§ã‚ã£ã¦ã‚‚Androidç«¯æœ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã€å€¤ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚EncryptedSharedPreferencesç›¸å½“ã®å‡¦ç†ã‚’ã€è‡ªå‰å®Ÿè£…ã—ã¦ã„ã‚‹ã‚ˆã†ãªã‚‚ã®ã€ãªã®ã§ã¯ãªã„ã‹ãªã¨ã€‚

ãªãŠç­†è€…ã¯ã€EncryptedSharedPreferencesã¨flutter_secure_storageã®å®Ÿè£…ã®å·®ç•°ã‚’ã€ç´°ã‹ãæ¯”è¼ƒã™ã‚‹èƒ½åŠ›ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚æ°—ã«ãªã‚‹æ–¹ã¯ã€ãœã²ãŠè¿‘ãã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã€å®Ÿè£…ã®é•ã„ãªã©ã‚’ã”ç¢ºèªã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

:::details å¼•ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰
`RSACipher18Implementation`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/android/src/main/java/com/it_nomads/fluttersecurestorage/ciphers/RSACipher18Implementation.java

`RSACipherOAEPImplementation`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/android/src/main/java/com/it_nomads/fluttersecurestorage/ciphers/RSACipherOAEPImplementation.java
:::

### é–¢é€£Issue

Androidã®å®Ÿè£…ã«ãŠã„ã¦ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã®Issueã§ã‚‚è­°è«–ãŒãªã•ã‚Œã¦ã„ã¾ã™ã€‚
ç‰¹ã«æœ‰ç”¨ãªã®ã¯ã€ä»¥ä¸‹ã®Issueã§ã™ã€‚
(ã“ã®è¨˜äº‹ã¨åŒã˜ãã€EncryptedSharedPreferencesã‚’åˆ©ç”¨ã—ãªã„ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚)

https://github.com/mogol/flutter_secure_storage/issues/413

ã‚ã‚‹æ„å‘³ã§ã€ä¸Šè¨˜Issueã‚’ç¢ºèªã™ã‚Œã°ã€ã“ã®è¨˜äº‹ã¯ä¸è¦ãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã©ã¡ã‚‰ã‹ã¨ã„ãˆã°ã€Androidã®å®Ÿè£…ã®ãƒ‘ãƒ¼ãƒˆã«ã¤ã„ã¦ã¯ã€Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è‡ªåˆ†ã§èª­ã‚€ãŸã‚ã®ã‚µãƒãƒ¼ãƒˆè¨˜äº‹ã¨ã—ã¦æ‰ãˆã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

---

ã¾ãŸã€æš—å·åŒ–ãŒç«¯æœ«ã«ç´ã¥ãä»¥ä¸Šã€AutoBackupã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®Issueã§è­°è«–ãŒãªã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/mogol/flutter_secure_storage/issues/541

flutter_secure_storageã‚’Androidã§åˆ©ç”¨ã™ã‚‹éš›ã«ã€ãœã²æ°—ã‚’ã¤ã‘ã¦ãŠããŸã„ç‚¹ã§ã™ã€‚

## iOS

iOSã®å®Ÿè£…ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚
`SwiftFlutterSecureStoragePlugin`ã®`read`ã¨`write`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¦‹ã‚‹ã¨ã€è¿½ã†ã¹ãå‡¦ç†ã®åŠåˆ†ãŒçµ‚ã‚ã‚Šã¾ã™ã€‚

```swift
private func read(_ call: FlutterMethodCall, _ result: @escaping FlutterResult) {
    let values = parseCall(call)
    if (values.key == nil) {
        result(FlutterError.init(code: "Missing Parameter", message: "write requires key parameter", details: nil))
        return
    }
    
    let response = flutterSecureStorageManager.read(key: values.key!, groupId: values.groupId, accountName: values.accountName, synchronizable: values.synchronizable, accessibility: values.accessibility)
    handleResponse(response, result)
}

private func write(_ call: FlutterMethodCall, _ result: @escaping FlutterResult) {
    if (!((call.arguments as! [String : Any?])["value"] is String)){
        result(FlutterError.init(code: "Invalid Parameter", message: "key parameter must be String", details: nil))
        return;
    }

    let values = parseCall(call)
    if (values.key == nil) {
        result(FlutterError.init(code: "Missing Parameter", message: "write requires key parameter", details: nil))
        return
    }

    if (values.value == nil) {
        result(FlutterError.init(code: "Missing Parameter", message: "write requires value parameter", details: nil))
        return
    }

    let response = flutterSecureStorageManager.write(key: values.key!, value: values.value!, groupId: values.groupId, accountName: values.accountName, synchronizable: values.synchronizable, accessibility: values.accessibility)

    handleResponse(response, result)
}
```

`flutterSecureStorageManager.read`ã¨`flutterSecureStorageManager.write`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯`FlutterSecureStorage`ã®`read`ã¨`write`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚èª­ã‚€å¿…è¦ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã®æ®‹ã‚ŠåŠåˆ†ãŒã€ã“ã¡ã‚‰ã§ã™ã€‚

```swift
internal func read(key: String, groupId: String?, accountName: String?, synchronizable: Bool?, accessibility: String?) -> FlutterSecureStorageResponse {
    let keychainQuery = baseQuery(key: key, groupId: groupId, accountName: accountName, synchronizable: synchronizable, accessibility: accessibility, returnData: true)
    
    var ref: AnyObject?
    let status = SecItemCopyMatching(
        keychainQuery as CFDictionary,
        &ref
    )
    
    var value: String? = nil
    
    if (status == noErr) {
        value = String(data: ref as! Data, encoding: .utf8)
    }

    return FlutterSecureStorageResponse(status: status, value: value)
}

internal func write(key: String, value: String, groupId: String?, accountName: String?, synchronizable: Bool?, accessibility: String?) -> FlutterSecureStorageResponse {        
    var keyExists: Bool = false

    switch containsKey(key: key, groupId: groupId, accountName: accountName, synchronizable: synchronizable, accessibility: accessibility) {
    case .success(let exists):
        keyExists = exists
        break;
    case .failure(let err):
        return FlutterSecureStorageResponse(status: err.status, value: nil)
    }

    var keychainQuery = baseQuery(key: key, groupId: groupId, accountName: accountName, synchronizable: synchronizable, accessibility: accessibility, returnData: nil)

    if (keyExists) {
        var attrAccessible = parseAccessibleAttr(accessibility: accessibility);

        let update: [CFString: Any?] = [
            kSecValueData: value.data(using: String.Encoding.utf8),
            kSecAttrAccessible: attrAccessible,
            kSecAttrSynchronizable: synchronizable
        ]
        
        let status = SecItemUpdate(keychainQuery as CFDictionary, update as CFDictionary)
        
        return FlutterSecureStorageResponse(status: status, value: nil)
    } else {
        keychainQuery[kSecValueData] = value.data(using: String.Encoding.utf8)
        
        let status = SecItemAdd(keychainQuery as CFDictionary, nil)

        return FlutterSecureStorageResponse(status: status, value: nil)
    }
}
```

iOSã«é¦´æŸ“ã¿ã®ã‚ã‚‹æ–¹ã¯ã€ã“ã®å‡¦ç†ã‚’èª­ã‚ã°ã€ŒKeyChainã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã—ã¦ã„ã‚‹ã ã‘ã€ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚‹ã§ã—ã‚‡ã†ã€‚é¦´æŸ“ã¿ã®ãªã„æ–¹ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚

https://developer.apple.com/documentation/security/keychain_services/keychain_items/searching_for_keychain_items

iOSã«ãŠã‘ã‚‹KeyChainã¯ã€Androidã®**ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ ¼ç´å‹ã‚­ãƒ¼ã‚¹ãƒˆã‚¢**ã«è©²å½“ã—ã¾ã™ã€‚é€šå¸¸ã€iPhoneã‚„iPadã«ãŠã„ã¦ã€KeyChainã«ä¿å­˜ã—ãŸæƒ…å ±ã¯**ã‚»ã‚­ãƒ¥ã‚¢**ã§ã‚ã‚‹ã¨è¦‹ãªã•ã‚Œã¾ã™ã€‚

https://support.apple.com/ja-jp/guide/security/secb0694df1a/web

ã‚ˆã£ã¦ã€iOSã®å®Ÿè£…ã«ãŠã„ã¦ã¯ã€KeyChainã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚Œã°OKã§ã™ã€‚ 

:::details å¼•ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰

`FlutterSecureStoragePlugin`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/ios/Classes/SwiftFlutterSecureStoragePlugin.swift

`FlutterSecureStorage`

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage/ios/Classes/FlutterSecureStorage.swift
:::

### é–¢é€£Issue

ãªãŠã€KeyChainã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ä»˜ãã€ã‚¢ãƒ—ãƒªã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒãªã•ã‚ŒãŸå ´åˆã«ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¾ã™ã€‚
Androidã®å®Ÿè£…ã§ã¯ã€AutoBackupã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€OSã«ã‚ˆã‚‹å‹•ä½œã®å·®åˆ†ã¨ãªã‚Šãˆã¾ã™ã€‚é–‹ç™ºä¸­ã¯æ°—ã¥ãã«ãã„ã®ã§ã€æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

https://github.com/mogol/flutter_secure_storage/issues/82

## Web

flutter_secure_storageã¯Webã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™
è­°è«–ã¯2019å¹´ã”ã‚ã‹ã‚‰ã€æ¬¡ã®Issueã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/mogol/flutter_secure_storage/issues/96

Webã®å®Ÿè£…ã¯ã€[js](https://pub.dev/packages/js)ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã€Web Crypto APIã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API

### subtle.dart

flutter_secure_storageã®Webå®Ÿè£…ã‚’èª­ã‚€ãŸã‚ã«ã¯ã€jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½¿ã„æ–¹ã‚’æŠŠæ¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã¯ç­†è€…ã®ç†è§£ã«ãªã‚Šã¾ã™ã€‚å³å¯†ãªå†…å®¹ã¯ã€jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®READMEã‚’ã”ç¢ºèªãã ã•ã„ã€‚

Dartã‹ã‚‰Web Crypto APIãªã©ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€Dartã®ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦**å‹**ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚
ã‹ã¤ã¦ã¯[js_facade_gen](https://github.com/dart-archive/js_facade_gen)ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚Šã€TypeScriptã®å‹å®šç¾©ã‹ã‚‰Dartã®å‹ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒè©¦ã¿ã‚‰ã‚Œã¦ã„ãŸã‚ˆã†ã§ã™ãŒã€ã™ã§ã«é–‹ç™ºã¯åœæ­¢ã—ã¦ã„ã¾ã™ã€‚ã‚ˆã£ã¦ã€ç¾åœ¨ã¯æ‰‹ä½œæ¥­ã§å‹ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®å‹å®šç¾©ã‚’è¡Œã£ã¦ã„ã‚‹ã®ãŒã€`subtle.dart`ã§ã™ã€‚

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage_web/lib/src/subtle.dart

`@JS`ã‚’ã¤ã‘ã¦ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€Dartã®ä»–ã®ã‚¯ãƒ©ã‚¹ã‹ã‚‰å‚ç…§ã—ãŸã¨ãã«ã€Web Crypto APIãªã©ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚å½“ç„¶ã§ã¯ã‚ã‚Šã¾ã™ãŒã€å‹å®šç¾©ã‚’å¤±æ•—ã—ãŸã¨ãã«ã¯ã€å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
flutter_secure_storageã®Webå®Ÿè£…ã§ã¯ã€å„å®šç¾©ã®ã‚³ãƒ¡ãƒ³ãƒˆéƒ¨ã«ã€å‚ç…§ã—ã¦ã„ã‚‹å‹å®šç¾©ã®URLãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚éå¸¸ã«èª­ã¿ã‚„ã™ãã€åŠ©ã‹ã‚Šã¾ã™ã€‚

### flutter_secure_storage_web.dart

https://github.com/mogol/flutter_secure_storage/blob/v9.0.0/flutter_secure_storage_web/lib/flutter_secure_storage_web.dart

Webã®readã¨writeãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

```dart
@override
Future<void> write({
  required String key,
  required String value,
  required Map<String, String> options,
}) async {
  final iv =
      html.window.crypto!.getRandomValues(Uint8List(12)).buffer.asUint8List();

  final algorithm = _getAlgorithm(iv);

  final encryptionKey = await _getEncryptionKey(algorithm, options);

  final encryptedContent = await js_util.promiseToFuture<ByteBuffer>(
    crypto.encrypt(
      algorithm,
      encryptionKey,
      Uint8List.fromList(
        utf8.encode(value),
      ),
    ),
  );

  final encoded =
      "${base64Encode(iv)}.${base64Encode(encryptedContent.asUint8List())}";

  html.window.localStorage["${options[_publicKey]!}.$key"] = encoded;
}

@override
Future<String?> read({
  required String key,
  required Map<String, String> options,
}) async {
  final value = html.window.localStorage["${options[_publicKey]!}.$key"];

  return _decryptValue(value, options);
}

Future<String?> _decryptValue(
  String? cypherText,
  Map<String, String> options,
) async {
  if (cypherText == null) {
    return null;
  }

  final parts = cypherText.split(".");

  final iv = base64Decode(parts[0]);
  final algorithm = _getAlgorithm(iv);

  final decryptionKey = await _getEncryptionKey(algorithm, options);

  final value = base64Decode(parts[1]);

  final decryptedContent = await js_util.promiseToFuture<ByteBuffer>(
    crypto.decrypt(
      _getAlgorithm(iv),
      decryptionKey,
      Uint8List.fromList(value),
    ),
  );

  final plainText = utf8.decode(decryptedContent.asUint8List());

  return plainText;
}
```

ã–ã£ãã‚Šã„ãˆã°ã€`_getEncryptionKey`ã§å¾—ã‚‰ã‚ŒãŸkeyã‚’åˆ©ç”¨ã—ã¦ã€`crypto.encrypt`ã¨`crypto.decrypt`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
å¼•æ•°ã«å…¥ã£ã¦ã„ã‚‹`options`ã¯ã€flutter_secure_storageã®`WebOptions`ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€`dbName`ã¨`publicKey`ã®2ã¤ã®å€¤ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

```dart
class WebOptions extends Options {
  const WebOptions({
    this.dbName = 'FlutterEncryptedStorage',
    this.publicKey = 'FlutterSecureStorage',
  });

  static const WebOptions defaultOptions = WebOptions();

  final String dbName;
  final String publicKey;

  @override
  Map<String, String> toMap() => <String, String>{
        'dbName': dbName,
        'publicKey': publicKey,
      };
}
```

ã“ã®å®šæ•°ã‚’æŒã¤ã“ã¨ã§ã€Webã®å®Ÿè£…ã§ã¯ã€`dbName`ã¨`publicKey`ã‚’åˆ©ç”¨ã—ã¦ã€KeyChainã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è­˜åˆ¥ã—ã¦ã„ã¾ã™ã€‚
ã©ã¡ã‚‰ã‹ã¨ã„ãˆã°ã€Androidã®å®Ÿè£…ã«è¿‘ã„å°è±¡ãŒã‚ã‚Šã¾ã™ã€‚æš—å·åŒ–ã¨è¤‡åˆã‚’Web Crypto APIã«æŠ•ã’ã€localStorageã¸ã®æ“ä½œã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

keyã¯`_getEncryptionKey`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚Šã€ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚

```dart
Future<html.CryptoKey> _getEncryptionKey(
  crypto.Algorithm algorithm,
  Map<String, String> options,
) async {
  late html.CryptoKey encryptionKey;
  final key = options[_publicKey]!;

  if (html.window.localStorage.containsKey(key)) {
    final jwk = base64Decode(html.window.localStorage[key]!);

    encryptionKey = await js_util.promiseToFuture<html.CryptoKey>(
      crypto.importKey("raw", jwk, algorithm, false, ["encrypt", "decrypt"]),
    );
  } else {
    //final crypto.getRandomValues(Uint8List(256));

    encryptionKey = await js_util.promiseToFuture<html.CryptoKey>(
      crypto.generateKey(algorithm, true, ["encrypt", "decrypt"]),
    );

    final jsonWebKey = await js_util
        .promiseToFuture<ByteBuffer>(crypto.exportKey("raw", encryptionKey));
    html.window.localStorage[key] = base64Encode(jsonWebKey.asUint8List());
  }

  return encryptionKey;
}
```

Dartã®ã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€æ¯”è¼ƒçš„èª­ã¿ã‚„ã™ã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ç”Ÿæˆã—ãŸ`encryptionKey`ã‚’jwtã¨ã—ã¦localStorageã«ä¿å­˜ã—ã€æ¬¡å›ä»¥é™ã¯ãã®å€¤ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

### Webã®å®Ÿè£…ã¯ã‚»ã‚­ãƒ¥ã‚¢ãªã®ã‹

:::message alert
ã“ã®é …ç›®ã«å¯¾ã—ã¦ã¯ã€ç­†è€…ã®çŸ¥è­˜ä¸è¶³ã«ã‚ˆã‚Šã€èª¤ã£ãŸç†è§£ã‚’ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
Webã®å®Ÿè£…ã®å‰ã«ã€ãœã²ãŠè¿‘ãã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ä¸€ç·’ã«ã€å®Ÿè£…ã«ã¤ã„ã¦æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
:::

flutter_secure_storageã®Webå®Ÿè£…ã¯**æ­£ã—ãFlutterã‚¢ãƒ—ãƒªãŒå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦**ã€ã‚ã‚‹ç¨‹åº¦ã¯æ”»æ’ƒã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã¯ã€ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚LocalStorageã‚’åˆ©ç”¨ã™ã‚‹éš›ã«ã€ç›´æ¥åˆ©ç”¨ã™ã‚‹ã‚ˆã‚Šã€å®‰å…¨ã«åˆ©ç”¨ã§ãã‚‹ã“ã¨ã¯é–“é•ã„ã‚ã‚Šã¾ã›ã‚“ã€‚
å¤§å‰æã§ã¯ã‚ã‚‹ã®ã§ã™ãŒã€ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãªã©ã®**æœ¬å½“ã«ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªæƒ…å ±**ã¯ã€[firebase_auth](https://pub.dev/packages/firebase_auth)ãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã¹ãã§ã™ã€‚flutter_secure_storageã‚’åˆ©ç”¨ã—ã¦ã€Flutter Webã§ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹å ´åˆã«ã¯ã€ã‚ˆãã‚ˆãèª¿æŸ»ã¨æ¤œè¨ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã€ç­†è€…ã®ç¾åœ¨ã®ç†è§£ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚ã€€

---

ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã¨ã®å¤§ããªé•ã„ã¨ã—ã¦ã€dev toolã®å­˜åœ¨ãŒã‚ã‚Šã¾ã™ã€‚LocalStorageã¯dev toolã«ã‚ˆã‚Šã€ç°¡å˜ã«é–²è¦§ã‚„ç·¨é›†ãŒå¯èƒ½ãªé ˜åŸŸã§ã™ã€‚ã“ã®ãŸã‚ã€flutter_secure_storageã®å®Ÿè£…ã‚’è¸ã¾ãˆã¦ã€LocalStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹jwtã‚’è¤‡åˆã™ã‚‹ã“ã¨ã¯ã€ä¸€å®šã®æŠ€è¡“åŠ›ãŒã‚ã‚Œã°å¯èƒ½ãã†ã«è¦‹ãˆã¾ã™ã€‚ã“ã®ç‚¹ãŒå•é¡Œã¨ãªã‚‹å ´åˆã«ã¯ã€public keyã®å€¤ã‚’`WebOptions`ã§å¤‰æ›´ã™ã‚‹ãªã©ã€(ç¾åœ¨ã®å®Ÿè£…ã§ã¯)ä½•ã‚‰ã‹ã®å¯¾å¿œã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚
ãã®ä»–ã€æ‚ªæ„ã®ã‚ã‚‹JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¢ãƒ—ãƒªã«æ··å…¥ã™ã‚‹ç‚¹ã«ã¤ã„ã¦ã‚‚ã€æ°—ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/Window/localStorage

LocalStorageã¯ã€åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒªã‚·ãƒ¼ã‚’æŒã£ã¦ãŠã‚Šã€åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®JavaScriptã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚ã“ã®ãŸã‚ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ‰±ã„ãªã©ã‚’èª¤ã‚‹ã“ã¨ãŒãªã‘ã‚Œã°ã€LocalStorageã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ä»–ã®ã‚µã‚¤ãƒˆã‹ã‚‰èª­ã¿å–ã‚‰ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã¾ãŸã€CanvasKitã«ã‚ˆã‚‹ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’åˆ©ç”¨ã—ã¦ã„ã‚Œã°ã€HTML DOMã®å·®ã—æ›¿ãˆã«ã‚ˆã‚‹æ”»æ’ƒã«ã‚‚å¯¾å¿œã§ããã†ã§ã™ã€‚ã¨ã¯ã„ãˆã€2023å¹´æœ«ç¾åœ¨ã§ã¯ã€ãƒ¢ãƒã‚¤ãƒ«å›ç·šå‘ã‘ã«HTMLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚‚å¤šã„ã§ã—ã‚‡ã†ã€‚ã“ã®æ„å‘³ã§ã€Flutterä»¥å¤–ã®SPAãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ãŠã‘ã‚‹æ”»æ’ƒãŒã€Flutter Webã§ã‚‚å•é¡Œã«ãªã‚‹æã‚Œã¯ã‚ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

ç¶šã„ã¦ã€æ„å›³ã—ãªã„JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ··å…¥ã«ã¤ã„ã¦ã€‚
Flutterã®å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ã€Flutterã‚„Dartã®ãƒãƒ¼ãƒ ãŒé–‹ç™ºã—ã¦ã„ãªã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¾å­˜ã—ãªã„ã‚ˆã†ã€ç´°å¿ƒã®æ³¨æ„ãŒæ‰•ã‚ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/flutter/flutter/issues/122713

https://github.com/flutter/flutter/wiki/Contributing-to-Plugins-and-Packages#dependencies

ã“ã®ãŸã‚ã€Flutterã®å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹é™ã‚Šã€æ„å›³ã—ãªã„JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚LocalStorageãŒJSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚‚èª­ã¿å–ã‚Œã¦ã—ã¾ã†ã“ã¨ãŒå•é¡Œã«ãªã‚‹ä»¥ä¸Šã€ã“ã®ç‚¹ã¯æœ‰åˆ©ã«åƒãã¯ãšã§ã™ã€‚

å•é¡ŒãŒã‚ã‚‹ã¨ã™ã‚Œã°ã€ã‚¢ãƒ—ãƒªã®é–‹ç™ºã®ãŸã‚ã«ã€é–‹ç™ºè€…ãŒè¿½åŠ ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚æ³¨æ„ãŒå¿…è¦ãªã®ã¯ã€Flutter Webç”¨ã®å®Ÿè£…ã‚’ç¢ºèªã™ã‚‹ã®ã¨åŒæ™‚ã«ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã§åˆ©ç”¨ã—ã¦ã„ã‚‹JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚
Flutter Webã§ã¯ã€å…¸å‹çš„ã«ã¯Dartãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã®JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã€`index.html`ã«ã‚¢ãƒ—ãƒªé–‹ç™ºè€…ãŒè¿½åŠ ã—ã¾ã™ã€‚ã“ã®ãŸã‚ã€ã‚¢ãƒ—ãƒªé–‹ç™ºè€…ã¯`index.html`ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€ã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã©ã®JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã‹æŠŠæ¡ã—ã¦ã„ã‚‹ã€ã¨è€ƒãˆã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã—ã‹ã—ã€Flutter Webå‘ã‘ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã«ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã§å‹•çš„ã«JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€ã‚‚ã®ãŒã‚ã‚‹ã®ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯Dartãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ä¾¿æ€§ã‚’ä¸Šã’ã¦ãã‚Œã‚‹ã‚‚ã®ã§ã™ãŒã€LocalStorageã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¯å½±éŸ¿ã‚’ä¸ãˆã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/DavBfr/dart_pdf/blob/printing-5.11.1/printing/lib/printing_web.dart#L90-L96

ãŸã¨ãˆã°[printing](https://pub.dev/packages/printing)ã¯ã€Webå‘ã‘ã®ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã«JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å®Ÿè¡Œæ™‚ã«èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚
ã“ã®ã‚±ãƒ¼ã‚¹ã¯[pdfjs](https://www.npmjs.com/package/pdfjs)ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã ã‘ãªã®ã§ã€å•é¡Œã¯ãªã„ã§ã—ã‚‡ã†ã€‚ä¸€æ–¹ã§ã€ã“ã®ã‚ˆã†ã«å‹•çš„ã«JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚ã‚‹ã“ã¨ã‚’çŸ¥ã‚‰ãªã‘ã‚Œã°ã€èª¤ã£ãŸåˆ¤æ–­ã‚’ã—ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

---

LocalStorageã®æŒ¯ã‚‹èˆã„ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚Flutter Webã®é–‹ç™ºã‚’ã—ã¦ã„ããŸã‚ã«ã€ç¶™ç¶šçš„ã«å‹‰å¼·ã›ã­ã°ã¨æ„Ÿã˜ã¦ã„ã‚‹ã¨ã“ã‚ã§ã™ã€‚

https://blog.flatt.tech/entry/auth0_access_token_poc

https://mizumotok.hatenablog.jp/entry/2021/08/04/114431

Flutter Webã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦ã¯ã€Flutter Webè‡ªä½“ãŒæ–°ã—ã„ã“ã¨ã‚‚ã‚ã‚Šã€ã¾ã ã¾ã è­°è«–ãŒãªã•ã‚Œã¦ã„ã‚‹æ®µéšã ã¨æ€ã„ã¾ã™ã€‚
ãªã«ã‹æ°—ã¥ã„ãŸã“ã¨ãªã©ã‚ã‚Œã°ã€ãœã²ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«æŠ•ç¨¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## ã¾ã¨ã‚

flutter_secure_storageã¯ã€å°å…¥ã™ã‚‹ã ã‘ã§ã€ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«è¡Œã†ã“ã¨ãŒã§ãã‚‹ç´ æ™´ã‚‰ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ãã—ã¦ã€Androidã‚„iOSã«é¦´æŸ“ã¿ã®ã‚ã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã‚ã‚Œã°ã€æ¯”è¼ƒçš„å®¹æ˜“ã«ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
æœ€è¿‘ã§ã¯Linuxã‚„Windowsã€macOSãªã©ã‚‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚Šã€ã¾ã™ã¾ã™ä¾¿åˆ©ã«ãªã£ã¦ã„ã¾ã™ã€‚è¤‡æ•°ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å‘ã‘ã«é–‹ç™ºã‚’è¡Œãˆã‚‹Flutterã®åˆ©ç‚¹ã‚’æ´»ã‹ã™æ„å‘³ã§ã‚‚ã€[shared_preferences](https://pub.dev/packages/shared_preferences)ã¨åŒç­‰ã®ã€æ¬ ã‹ã›ãªã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸€ã¤ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ã“ã®ä¾¿åˆ©ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å…¨ã¦ãŠä»»ã›ã€ã¨ã„ã†å½¢ã§ã‚‚(ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã™ã—)å•é¡Œã¯ãªã„ã®ã‹ãªã€ã¨ã‚‚æ€ã„ã¾ã™ã€‚ä¸€æ–¹ã§ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å®Ÿè£…ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè‡ªä¿¡ã‚’æŒã£ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
æœ¬è¨˜äº‹ã‚’ãã£ã‹ã‘ã«ã€flutter_secure_storageã®å®Ÿè£…ã«é–¢å¿ƒã‚’æŒã£ã¦ãã‚Œã‚‹äººãŒå¢—ãˆã¦ãã‚Œã‚Œã°ã€ã¨ã¦ã‚‚å¬‰ã—ã„ã“ã¨ã ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚
